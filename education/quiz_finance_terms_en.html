<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thermo-Credit finance glossary drill (EN) | ToppyMicroServices</title>
    <meta name="description" content="Interactive Thermo-Credit finance glossary in English: CET1, RWA, LCR, NSFR, policy levers, and more via MC, multi-select, and text prompts with learning mode." />
    <link rel="canonical" href="https://toppymicros.com/education/quiz_finance_terms_en.html" />

    <!-- Icons -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="/favicon-32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ToppyMicroServices ‚Äî Thermo-Credit & AI Reliability" />
    <meta property="og:description" content="Open math + dashboards for credit allocation (Thermo-Credit) and AI reliability." />
    <meta property="og:url" content="https://toppymicros.com/education/quiz_finance_terms_en.html" />
    <meta property="og:image" content="https://toppymicros.com/og-brand-clean.png" />
    <meta property="og:site_name" content="ToppyMicroServices" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="ToppyMicroServices ‚Äî Thermo-Credit & AI Reliability" />
    <meta name="twitter:description" content="Open math + dashboards for credit allocation (Thermo-Credit) and AI reliability." />
    <meta name="twitter:image" content="https://toppymicros.com/og-brand-clean.png" />
  <link rel="alternate" hreflang="ja" href="quiz_finance_terms.html" />
  <link rel="alternate" hreflang="en" href="quiz_finance_terms_en.html" />
    <link rel="stylesheet" href="quiz.css" />
    <script defer data-domain="toppymicros.com" data-auto="false" src="https://plausible.io/js/script.js"></script>
    <script defer src="../assets/global.js"></script>
  <style>
  :root{--bg-gradient-top:#0b0f14;--bg-gradient-bottom:#0d141c;--fg:#e7eef6;--muted:#8aa0b5;--accent:#4ea1ff;--accent-2:#9be37f;--warn:#ffcc66;--danger:#ff6b6b;--card:#0f1722;--glass:rgba(255,255,255,0.03);--glass-2:rgba(255,255,255,0.02);--border:#1c2531;--ok:#36d399;--shadow:0 12px 30px rgba(2,6,23,.6);--choice-hover:linear-gradient(90deg,rgba(78,161,255,0.04),rgba(155,227,127,0.02));--control-padding-y:.5rem;--control-padding-x:1rem;--control-font-size:.9rem;--control-min-height:44px;--control-icon-size:1.05rem}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(180deg,var(--bg-gradient-top),var(--bg-gradient-top) 40%,var(--bg-gradient-bottom) 100%);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";transition:background .3s ease,color .3s ease}
    a{color:var(--accent)}.container{max-width:980px;margin:0 auto;padding:28px 16px 48px}header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    h1{font-size:clamp(20px,3.6vw,34px);margin:0 0 6px}h2{font-size:clamp(16px,2.6vw,22px);margin:0;color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .75rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:.85rem;line-height:1;min-height:var(--control-min-height)}
    .badge.clickable{cursor:pointer;user-select:none}
    .badge.clickable:focus{outline:2px solid var(--accent);outline-offset:2px}
    .card{background:linear-gradient(180deg,var(--glass),var(--glass-2));border:1px solid rgba(255,255,255,0.03);border-radius:16px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .panel{display:grid;gap:12px;padding:16px;margin:16px 0}.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#141c27;color:var(--fg);padding:.55rem .8rem;border-radius:10px;cursor:pointer;transition:all .15s ease}
    .btn:hover{border-color:#2a3748}
  .lang-toggle{display:inline-flex;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);background:rgba(15,23,34,0.6);padding:4px;flex:0 0 auto;min-width:260px;flex-shrink:0}
  .lang-toggle a{padding:var(--control-padding-y) var(--control-padding-x);background:transparent;border:0;color:var(--muted);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;font-weight:600;font-size:var(--control-font-size);white-space:nowrap;min-width:120px;text-align:center;flex:1 1 0;line-height:1}
  .lang-toggle a.active{background:linear-gradient(90deg,var(--accent),#59b0ff);color:white}
  .theme-toggle{appearance:none;border:1px solid rgba(255,255,255,0.18);background:rgba(15,23,34,0.65);color:var(--muted);padding:var(--control-padding-y) var(--control-padding-x);border-radius:999px;font-size:var(--control-font-size);font-weight:600;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;min-height:var(--control-min-height);line-height:1}
  .theme-toggle:hover{color:var(--fg);border-color:rgba(255,255,255,0.35)}
  .theme-toggle .theme-icon{font-size:var(--control-icon-size);line-height:1}
  .theme-toggle .theme-label{line-height:1;font-size:var(--control-font-size)}
  .header-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-start}
  .brand{display:flex;align-items:flex-start;margin-bottom:6px}
  .brand a{display:inline-flex;align-items:center;gap:.65rem;text-decoration:none;color:var(--fg);font-weight:600;font-size:clamp(16px,2.1vw,20px);letter-spacing:.03em}
  .brand img{height:40px;width:auto;max-width:140px}
  .brand .name{white-space:nowrap}
  .answer-btn{appearance:none;border:1px dashed rgba(255,255,255,0.16);background:rgba(15,23,34,0.6);color:var(--muted);padding:.35rem .8rem;border-radius:8px;cursor:pointer;transition:all .15s ease;font-size:.85rem}
  .answer-btn:hover{color:var(--fg);border-color:rgba(255,255,255,0.35)}
    .btn.ghost{background:transparent}.btn.primary{background:linear-gradient(180deg,#1b2a3a,#132030);border-color:#223045}.btn.success{background:#153521;border-color:#1d5b3f}.btn.warn{background:#2a2412;border-color:#5f4c1a;color:#ffdf99}
    .switch{display:inline-flex;gap:.6rem;align-items:center}input[type="checkbox" i]{cursor:pointer}
    input[type="checkbox"], input[type="radio"]{accent-color:var(--accent)}
    /* Modern toggle for settings */
    .switch input{position:absolute;opacity:0;width:0;height:0}
    .switch .ui-toggle{width:52px;height:28px;border-radius:999px;border:1px solid var(--border);background:#101826;position:relative;display:inline-block;transition:all .18s ease;box-shadow:inset 0 2px 6px rgba(0,0,0,.35)}
    .switch .ui-toggle::after{content:"";position:absolute;top:50%;left:4px;transform:translateY(-50%);width:22px;height:22px;border-radius:50%;background:linear-gradient(180deg,#f9fafb,#dbe3ee);box-shadow:0 2px 4px rgba(0,0,0,.35);transition:left .18s ease}
    .switch input:checked + .ui-toggle{background:linear-gradient(90deg,var(--accent),#59b0ff);border-color:#2a7dd6}
    .switch input:checked + .ui-toggle::after{left:calc(100% - 26px)}
    .switch .switch-label{color:var(--muted)}
    .switch:focus-within .ui-toggle{outline:2px solid rgba(78,161,255,.6);outline-offset:2px}
    .scope,.tip{padding:16px}.scope ul{margin:.35rem 0 .1rem 1.1rem}.muted{color:var(--muted)}
    details.cheatsheet{margin:16px 0}details.cheatsheet summary{cursor:pointer;padding:12px 16px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));border:1px solid var(--border);color:var(--fg)}.sheet{padding:16px 16px 4px}
    .q{padding:16px;margin:18px 0;transition:transform .12s ease,box-shadow .12s ease}.q header{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px}.q h4{margin:0;font-size:18px}.q .type{font-size:.8rem;color:var(--muted)}.q .body{display:grid;gap:12px}
  .choices{display:grid;gap:8px;margin-left:.2rem;padding:12px;border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,var(--glass),var(--glass-2))}
  .choice{display:flex;gap:10px;align-items:center;padding:12px 12px 12px 46px;border:1px dashed transparent;border-radius:16px;transition:all .18s ease;position:relative;min-height:46px}
  .choice:hover{background:var(--choice-hover);transform:translateY(-3px);box-shadow:0 6px 18px rgba(2,6,23,.45)}
  /* Hide native control but keep accessible */
  .choice input{position:absolute!important;width:1px;height:1px;margin:-1px;padding:0;border:0;clip:rect(1px,1px,1px,1px);overflow:hidden}
  /* Custom indicator */
  .choice{--ind-size:18px;--ind-radius:50%}
  .choice:has(input[type=checkbox]){--ind-radius:6px}
  .choice::before{content:"";position:absolute;left:14px;top:50%;transform:translateY(-50%);width:var(--ind-size);height:var(--ind-size);border-radius:var(--ind-radius);border:2px solid var(--border);background:rgba(255,255,255,0.04)}
  .choice::after{content:"";position:absolute;left:14px;top:50%;transform:translate(3px,-50%) scale(.2);transform-origin:center;border-radius:50%;width:calc(var(--ind-size) - 6px);height:calc(var(--ind-size) - 6px);background:linear-gradient(180deg,#5aaaff,#2d7df0);opacity:0;transition:transform .18s ease,opacity .18s ease}
  .choice:has(input[type=checkbox])::after{content:"‚úì";width:auto;height:auto;background:transparent;color:white;font-weight:800;font-size:12px;left:calc(14px + 9px);transform:translate(-50%,-50%) scale(.2);text-shadow:0 1px 1px rgba(0,0,0,.35)}
  .choice:has(input[type=checkbox]:checked)::before{background:linear-gradient(180deg,#3a8bff,#2d7df0);border-color:#2a7dd6}
  .choice:has(input[type=radio]:checked)::after{opacity:1;transform:translate(3px,-50%) scale(1)}
  .choice:has(input[type=checkbox]:checked)::after{opacity:1;transform:translate(-50%,-50%) scale(1)}
  .choice:has(input:checked){background:linear-gradient(90deg,rgba(78,161,255,0.08),rgba(155,227,127,0.04));border:1px solid rgba(78,161,255,0.35)}
  .choice:has(input:focus-visible){outline:2px solid rgba(78,161,255,.7);outline-offset:2px}
  .choice.correct{border-color:#1f3f2c;background:rgba(54,211,153,.07)}
  .choice.wrong{border-color:#4a2525;background:rgba(255,107,107,.06)}
    .explain{display:none;padding:12px;border-left:3px solid #2a6bb8;background:#0f1722;border-radius:8px}.explain.show{display:block}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

  /* Active tasks: classify (drag & drop) */
  .dd-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .bucket{border:1px dashed var(--border);border-radius:14px;padding:10px;min-height:72px;background:rgba(255,255,255,0.02)}
  .bucket h5{margin:0 0 6px;font-size:.9rem;color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .6rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.04);cursor:grab;user-select:none;margin:4px;-webkit-user-drag:element;touch-action:none}
  .chip:active{cursor:grabbing}
  .chip.selected{border-color:rgba(78,161,255,0.65);box-shadow:0 0 0 2px rgba(78,161,255,0.35);background:rgba(78,161,255,0.08)}
  .bucket.hover{border-color:rgba(78,161,255,0.55);background:rgba(78,161,255,0.06)}

  /* Active tasks: segmented chart selector */
  .mini-chart{position:relative;border:1px solid var(--border);border-radius:14px;padding:10px;background:linear-gradient(180deg,var(--glass),var(--glass-2))}
  .segments{position:absolute;left:10px;right:10px;bottom:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .segment{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:var(--muted);border-radius:10px;padding:.25rem .4rem;cursor:pointer}
  .segment.selected{background:linear-gradient(90deg,var(--accent),#59b0ff);color:#fff;border-color:#2a7dd6}

  /* Live score */
  #score-badge{display:inline-flex;align-items:center;justify-content:center;gap:.25rem;padding:.25rem .75rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:.85rem;line-height:1;min-height:var(--control-min-height);white-space:nowrap}
  @media print{.panel button,.panel input,.panel .badge{display:none!important}body{background:#fff;color:#000}.card{box-shadow:none;border-color:#ccc}}

  body[data-theme="light"]{--bg-gradient-top:#f5f7fb;--bg-gradient-bottom:#e6ebf5;--fg:#1f2937;--muted:#5a6b83;--accent:#2563eb;--accent-2:#16a34a;--card:#ffffff;--glass:rgba(255,255,255,0.95);--glass-2:rgba(255,255,255,0.88);--border:rgba(15,23,42,0.12);--shadow:0 12px 30px rgba(15,23,42,0.12);--choice-hover:linear-gradient(90deg,rgba(37,99,235,0.08),rgba(22,163,74,0.05))}
  body[data-theme="light"] .card{background:linear-gradient(180deg,rgba(255,255,255,0.97),rgba(255,255,255,0.9));border:1px solid rgba(15,23,42,0.1);box-shadow:var(--shadow);color:var(--fg)}
  body[data-theme="light"] .lang-toggle{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.8)}
  body[data-theme="light"] .lang-toggle a{color:#4b5563}
  body[data-theme="light"] .theme-toggle{border-color:rgba(15,23,42,0.15);background:rgba(255,255,255,0.85);color:#4b5563}
  body[data-theme="light"] .theme-toggle:hover{color:#1f2937;border-color:rgba(37,99,235,0.45)}
  body[data-theme="light"] .answer-btn{background:rgba(255,255,255,0.9);color:#4b5563;border-color:rgba(15,23,42,0.16)}
  body[data-theme="light"] .answer-btn:hover{color:#1f2937;border-color:rgba(37,99,235,0.35)}
  body[data-theme="light"] .btn{border-color:rgba(15,23,42,0.12)}
  body[data-theme="light"] .btn.ghost{background:rgba(255,255,255,0.7);color:#1f2937}
  body[data-theme="light"] .btn.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border-color:#1d4ed8;color:#f8fafc}
  body[data-theme="light"] .btn.success{background:#22c55e;border-color:#16a34a;color:#f0fdf4}
  body[data-theme="light"] .btn.warn{background:#fde68a;border-color:#f59e0b;color:#92400e}
  body[data-theme="light"] .choices{border-color:rgba(15,23,42,0.12);background:rgba(255,255,255,0.95)}
  body[data-theme="light"] .choice:hover{box-shadow:0 6px 18px rgba(15,23,42,0.12)}
  body[data-theme="light"] .choice::before{background:rgba(0,0,0,0.02);border-color:rgba(15,23,42,0.25)}
  body[data-theme="light"] .choice.correct{border-color:rgba(34,197,94,0.45);background:rgba(34,197,94,0.15)}
  body[data-theme="light"] .choice.wrong{border-color:rgba(248,113,113,0.4);background:rgba(248,113,113,0.18)}
  body[data-theme="light"] .explain{background:rgba(226,232,240,0.9);border-left:3px solid #2563eb;color:#1f2937}
  body[data-theme="light"] .muted{color:#5a6b83}
  body[data-theme="light"] .badge{border-color:rgba(15,23,42,0.15);background:rgba(255,255,255,0.75);color:#475569}
  body[data-theme="light"] details.cheatsheet summary{background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.92));color:#1f2937}
  body[data-theme="light"] .brand a{color:#1f2937}
  </style>
  </head>
  <body data-theme="dark">
  <script>
    window.DRILL_SETTINGS = {
      SKILL_NAME: "ECB/BIS Finance Terms",
      SKILL_SUBTITLE: "Beginner Keyword Quiz",
      GOAL_DESCRIPTION: "Explain key terms in your own words",
      LEARNING_MODE_DEFAULT: true,
      BRAND_NAME: "ToppyMicroServices",
      BRAND_LOGO: "og-brand-clean.min.png",
      BRAND_URL: "/"
    };
  </script>
  <div class="container">
    <header>
      <div>
        <div class="brand">
          <a id="brand-link" href="/" aria-label="ToppyMicroServices">
            <img id="brand-logo" alt="ToppyMicroServices logo" src="og-brand-clean.min.png" width="40" height="40">
            <span id="brand-name" class="name">ToppyMicroServices</span>
          </a>
        </div>
        <h1 id="title">ECB/BIS Finance Terms 101: Beginner Keyword Quiz (Drill)</h1>
        <h2 id="subtitle">A reading drill to reach: Explain key terms in your own words</h2>
      </div>
      <div class="header-controls">
        <button type="button" class="theme-toggle" id="themeToggle" aria-pressed="false" aria-label="Switch to light mode" data-next="light">
          <span class="theme-icon" aria-hidden="true">‚òÄÔ∏è</span>
          <span class="theme-label">Light Mode</span>
        </button>
        <div class="lang-toggle" aria-label="Language switcher">
          <a href="quiz_finance_terms.html">Êó•Êú¨Ë™û</a>
          <a href="quiz_finance_terms_en.html" class="active" aria-current="page">English</a>
        </div>
        <button type="button" class="badge clickable" id="mode-badge" aria-live="polite" aria-pressed="true" title="Click to toggle Learning/Test">Learning Mode</button>
        <span id="score-badge" aria-live="polite" title="Live score">0 / 0</span>
      </div>
    </header>

    <section class="card scope" aria-labelledby="scope-h">
      <h3 id="scope-h">Scope</h3>
      <ul>
        <li><strong>Assumed Level</strong>: Beginner in finance; aims to read materials by understanding terms.</li>
        <li><strong>Topics Covered</strong>:
          <ul>
            <li>Basics of ECB / BIS / WDI / FRED</li>
            <li>ECB BSI concept of Outstanding (stock) and sector breakdowns</li>
            <li>M3, loan stocks, policy rates, spreads, liquidity</li>
          </ul>
        </li>
        <li><strong>Out of Scope</strong>: Advanced derivatives, detailed accounting entries, Basel formula derivations.</li>
      </ul>
    </section>

    <section class="card panel" aria-labelledby="ops-h">
      <h3 id="ops-h">Controls</h3>
      <div class="row">
        <label class="switch" for="learningMode">
          <input id="learningMode" type="checkbox" checked>
          <span class="ui-toggle" aria-hidden="true"></span>
          <span class="switch-label">Learning mode (show explanation immediately)</span>
        </label>
      </div>
      <div class="row">
        <button class="btn ghost" id="showAll">Show All Explanations</button>
        <button class="btn ghost" id="hideAll">Hide All Explanations</button>
        <button class="btn primary" id="regen" data-results-target="results-panel-top">Regenerate Results Table</button>
        <button class="btn success" id="showAnswersScore" data-results-target="results-panel-top">Show Answers & Score</button>
      </div>
      <p class="tip muted"><strong>Tip:</strong> Aim to transform ‚ÄúI recognize it‚Äù into ‚ÄúI can explain it clearly‚Äù.</p>
      <p class="muted" id="usage-note">How to use: 1) In Learning Mode, explanations show immediately when you answer. 2) Use ‚ÄúShow Answers & Score‚Äù to highlight correct answers and display your current score. 3) Use ‚ÄúRegenerate Results Table‚Äù to rebuild the summary.</p>
      <div class="results card" id="results-panel-top" aria-live="polite" style="display:none"></div>
    </section>

    <details class="cheatsheet card">
      <summary>Cheat Sheet: Quick Reference</summary>
      <div class="sheet">
        <ul>
          <li><strong>Outstanding</strong>: End-period amount still outstanding (stock).</li>
          <li><strong>M3</strong>: Broad money = cash + deposits + near-money assets.</li>
          <li><strong>Depth</strong>: Size (loan stock / bond outstanding).</li>
          <li><strong>Turnover</strong>: Trading activity (e.g. stock market turnover ratio).</li>
          <li><strong>DFR / MRO</strong>: Key ECB policy rates.</li>
          <li><strong>Liquidity</strong>: Ease of converting to cash quickly.</li>
        </ul>
      </div>
    </details>

    <section id="questions">
      <!-- Q01 -->
      <article class="q card" data-id="Q01" data-type="mc" data-answer="b">
        <header>
          <h4>Q01: What does ‚ÄúOutstanding‚Äù most closely mean?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <p>In ECB BSI ‚ÄúOutstanding amounts‚Äù, what does ‚ÄúOutstanding‚Äù represent?</p>
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q01" value="a"> A. Flow of new transactions during the period</label>
            <label class="choice"><input type="radio" name="Q01" value="b"> B. Amount remaining outstanding at a point in time (stock)</label>
            <label class="choice"><input type="radio" name="Q01" value="c"> C. Policy rate target chosen by the ECB</label>
          </fieldset>
          <div class="explain" id="exp-Q01">
            <strong>Explanation:</strong> Outstanding = end-period balance (stock). Separate from flow.
          </div>
        </div>
      </article>

      <!-- Q02 (Classify: Drag & Drop) -->
      <article class="q card" data-id="Q02" data-type="classify" data-answer="stock:a,c,e;flow:b,d,f">
        <header>
          <h4>Q02: Classify each term into ‚ÄúStock‚Äù vs ‚ÄúFlow‚Äù (drag & drop)</h4>
          <span class="type">Type: Classify (DnD)</span>
        </header>
        <div class="body">
          <div class="dd-wrap">
            <div class="bucket" data-group="stock" aria-label="Stock bucket">
              <h5>Stock</h5>
            </div>
            <div class="bucket" data-group="flow" aria-label="Flow bucket">
              <h5>Flow</h5>
            </div>
          </div>
          <div class="bucket pool" data-group="pool" aria-label="Pool of terms">
            <span class="chip" draggable="true" data-value="a">Outstanding balance</span>
            <span class="chip" draggable="true" data-value="b">New transactions (monthly)</span>
            <span class="chip" draggable="true" data-value="c">Loans outstanding</span>
            <span class="chip" draggable="true" data-value="d">New lending this month</span>
            <span class="chip" draggable="true" data-value="e">M3 stock</span>
            <span class="chip" draggable="true" data-value="f">Net issuance (this month)</span>
          </div>
          <div class="explain" id="exp-Q02">
            <strong>Explanation:</strong> Stocks are amounts at a point in time; flows are amounts over a period. Loan/M3 stocks are ‚ÄúStock‚Äù; new transactions or net issuance are ‚ÄúFlow‚Äù.
          </div>
        </div>
      </article>

      <!-- Q03 (Chart segment select) -->
      <article class="q card" data-id="Q03" data-type="segment" data-answer="2">
        <header>
          <h4>Q03: Pick the period with the strongest monetary tightening</h4>
          <span class="type">Type: Chart segment</span>
        </header>
        <div class="body">
          <div class="mini-chart" style="height:180px">
            <canvas id="miniChart" width="560" height="110" style="width:100%;height:110px"></canvas>
            <div class="segments" role="group" aria-label="Pick period">
              <button type="button" class="segment" data-idx="1">Period A</button>
              <button type="button" class="segment" data-idx="2">Period B</button>
              <button type="button" class="segment" data-idx="3">Period C</button>
            </div>
          </div>
          <p class="muted" style="margin:.4rem 0 0">Blue = policy rate, Green = loan growth (schematic)</p>
          <div class="explain" id="exp-Q03">
            <strong>Explanation:</strong> Tightening typically shows rising policy rates and slowing loan growth together. Period B matches this best.
          </div>
        </div>
      </article>
      <!-- Q04 -->
      <article class="q card" data-id="Q04" data-type="mc" data-answer="a">
        <header>
          <h4>Q04: What is the role of the ECB?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q04" value="a"> A. Central bank for the euro area (monetary policy, liquidity)</label>
            <label class="choice"><input type="radio" name="Q04" value="b"> B. International auditor for listed firms</label>
            <label class="choice"><input type="radio" name="Q04" value="c"> C. Ministry managing national fiscal deficits</label>
          </fieldset>
          <div class="explain" id="exp-Q04">
            <strong>Explanation:</strong> ECB sets policy rates (MRO, DFR) aiming at price stability.
          </div>
        </div>
      </article>

      <!-- Q05 -->
      <article class="q card" data-id="Q05" data-type="mc" data-answer="c">
        <header>
          <h4>Q05: What does BSI stand for and mainly cover?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q05" value="a"> A. Bond Spread Index (spreads of gov vs corporate)</label>
            <label class="choice"><input type="radio" name="Q05" value="b"> B. Banking Stability Indicator</label>
            <label class="choice"><input type="radio" name="Q05" value="c"> C. Banking Statistics (balance sheet items)</label>
          </fieldset>
          <div class="explain" id="exp-Q05">
            <strong>Explanation:</strong> BSI shows stocks (Outstanding) of loans, deposits etc.
          </div>
        </div>
      </article>

      <!-- Q06 -->
      <article class="q card" data-id="Q06" data-type="mc" data-answer="b">
        <header>
          <h4>Q06: What are ‚ÄúCurrency and Deposits‚Äù?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q06" value="a"> A. Securities + derivatives</label>
            <label class="choice"><input type="radio" name="Q06" value="b"> B. Cash, current, savings, time and other highly liquid deposits</label>
            <label class="choice"><input type="radio" name="Q06" value="c"> C. Mortgage and corporate loans</label>
          </fieldset>
          <div class="explain" id="exp-Q06">
            <strong>Explanation:</strong> These are the most liquid asset group.
          </div>
        </div>
      </article>

      <!-- Q07 (Multi-select) -->
      <article class="q card" data-id="Q07" data-type="ms" data-answer="a,c">
        <header>
          <h4>Q07: Which fit ‚ÄúNon-Financial Corporations (NFC)‚Äù? (multi-select)</h4>
          <span class="type">Type: Multi-Select</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="checkbox" name="Q07" value="a"> A. Manufacturing firms</label>
            <label class="choice"><input type="checkbox" name="Q07" value="b"> B. Investment funds</label>
            <label class="choice"><input type="checkbox" name="Q07" value="c"> C. Service sector firms</label>
            <label class="choice"><input type="checkbox" name="Q07" value="d"> D. Pension funds</label>
          </fieldset>
          <div class="explain" id="exp-Q07">
            <strong>Explanation:</strong> NFC excludes financial firms. Funds/pensions fall under other financial institutions.
          </div>
        </div>
      </article>

      <!-- Q08 -->
      <article class="q card" data-id="Q08" data-type="mc" data-answer="c">
        <header>
          <h4>Q08: Best description of M3?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q08" value="a"> A. Sum of government fiscal deficits</label>
            <label class="choice"><input type="radio" name="Q08" value="b"> B. Banks' CET1 capital</label>
            <label class="choice"><input type="radio" name="Q08" value="c"> C. Broad money: cash + deposits + near money assets</label>
          </fieldset>
          <div class="explain" id="exp-Q08">
            <strong>Explanation:</strong> M3 is a core monetary aggregate; studied for links with economic cycles.
          </div>
        </div>
      </article>

      <!-- Q09 -->
      <article class="q card" data-id="Q09" data-type="mc" data-answer="a">
        <header>
          <h4>Q09: Eurosystem balance sheet (total assets) is a proxy for?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q09" value="a"> A. Size of central bank liquidity provision (monetary base proxy)</label>
            <label class="choice"><input type="radio" name="Q09" value="b"> B. Average profitability of listed companies</label>
            <label class="choice"><input type="radio" name="Q09" value="c"> C. Average household savings rate</label>
          </fieldset>
          <div class="explain" id="exp-Q09">
            <strong>Explanation:</strong> Expansion signals strength of accommodation (QE phases).
          </div>
        </div>
      </article>

      <!-- Q10 -->
      <article class="q card" data-id="Q10" data-type="mc" data-answer="b">
        <header>
          <h4>Q10: ‚ÄúLoans outstanding‚Äù refers to?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q10" value="a"> A. Only new loans granted this month</label>
            <label class="choice"><input type="radio" name="Q10" value="b"> B. Total end-period loan balance not yet repaid</label>
            <label class="choice"><input type="radio" name="Q10" value="c"> C. Only defaulted loans</label>
          </fieldset>
          <div class="explain" id="exp-Q10">
            <strong>Explanation:</strong> Outstanding = accumulated remaining balance; distinct from flow.
          </div>
        </div>
      </article>

      <!-- Q11 -->
      <article class="q card" data-id="Q11" data-type="mc" data-answer="c">
        <header>
          <h4>Q11: Define ‚ÄúYield‚Äù concisely.</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q11" value="a"> A. Stock price volatility</label>
            <label class="choice"><input type="radio" name="Q11" value="b"> B. Nominal GDP growth rate</label>
            <label class="choice"><input type="radio" name="Q11" value="c"> C. Return earned from a bond or similar instrument</label>
          </fieldset>
          <div class="explain" id="exp-Q11">
            <strong>Explanation:</strong> Example: 10Y government bond yield shaped by rates & inflation expectations.
          </div>
        </div>
      </article>

      <!-- Q12 -->
      <article class="q card" data-id="Q12" data-type="mc" data-answer="b">
        <header>
          <h4>Q12: Natural definition of ‚ÄúCredit spread‚Äù?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q12" value="a"> A. Policy rate ‚àí government bond yield</label>
            <label class="choice"><input type="radio" name="Q12" value="b"> B. Corporate bond yield ‚àí same maturity government yield</label>
            <label class="choice"><input type="radio" name="Q12" value="c"> C. Deposit rate ‚àí loan rate</label>
          </fieldset>
          <div class="explain" id="exp-Q12">
            <strong>Explanation:</strong> Higher risk raises required corporate yield widening the spread.
          </div>
        </div>
      </article>

      <!-- Q13 -->
      <article class="q card" data-id="Q13" data-type="mc" data-answer="a">
        <header>
          <h4>Q13: MIR is which statistic?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q13" value="a"> A. Bank lending & deposit rates</label>
            <label class="choice"><input type="radio" name="Q13" value="b"> B. Stock market turnover</label>
            <label class="choice"><input type="radio" name="Q13" value="c"> C. House price index</label>
          </fieldset>
          <div class="explain" id="exp-Q13">
            <strong>Explanation:</strong> MIR covers household & corporate loan/deposit rates.
          </div>
        </div>
      </article>

      <!-- Q14 (Multi-select) -->
      <article class="q card" data-id="Q14" data-type="ms" data-answer="a,c">
        <header>
          <h4>Q14: Suitable proxies for market ‚Äúdepth‚Äù? (multi-select)</h4>
          <span class="type">Type: Multi-Select</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="checkbox" name="Q14" value="a"> A. Private sector loan stock (ECB BSI)</label>
            <label class="choice"><input type="checkbox" name="Q14" value="b"> B. Only FX bid-ask spread</label>
            <label class="choice"><input type="checkbox" name="Q14" value="c"> C. Bond Outstanding (BIS)</label>
            <label class="choice"><input type="checkbox" name="Q14" value="d"> D. Market cap of a single firm only</label>
          </fieldset>
          <div class="explain" id="exp-Q14">
            <strong>Explanation:</strong> Depth = size / mass. Loan stock or bond outstanding are natural proxies.
          </div>
        </div>
      </article>

      <!-- Q15 -->
      <article class="q card" data-id="Q15" data-type="mc" data-answer="b">
        <header>
          <h4>Q15: Market where ‚ÄúTurnover‚Äù is most used?</h4>
          <span class="type">Type: Multiple Choice</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="radio" name="Q15" value="a"> A. Real estate market</label>
            <label class="choice"><input type="radio" name="Q15" value="b"> B. Equity market (trading value √∑ market cap)</label>
            <label class="choice"><input type="radio" name="Q15" value="c"> C. Labor market</label>
          </fieldset>
          <div class="explain" id="exp-Q15">
            <strong>Explanation:</strong> Example: stock market turnover ratio (WDI).
          </div>
        </div>
      </article>

      <!-- Q16 (Multi-select) -->
      <article class="q card" data-id="Q16" data-type="ms" data-answer="a,c">
        <header>
          <h4>Q16: Included among ECB key policy rates? (multi-select)</h4>
          <span class="type">Type: Multi-Select</span>
        </header>
        <div class="body">
          <fieldset class="choices">
            <label class="choice"><input type="checkbox" name="Q16" value="a"> A. Deposit Facility Rate (DFR)</label>
            <label class="choice"><input type="checkbox" name="Q16" value="b"> B. Federal Funds Rate (US)</label>
            <label class="choice"><input type="checkbox" name="Q16" value="c"> C. Main Refinancing Operations (MRO)</label>
            <label class="choice"><input type="checkbox" name="Q16" value="d"> D. Government bond yield (market-determined)</label>
          </fieldset>
          <div class="explain" id="exp-Q16">
            <strong>Explanation:</strong> ECB-specific: DFR & MRO. Distinct from US FFR or market yields.
          </div>
        </div>
      </article>

      <!-- Q17 (Short Text: regex) -->
      <article class="q card" data-id="Q17" data-type="text" data-eval="regex" data-answer="^Q-?DEC$">
        <header>
          <h4>Q17: Abbreviation for quarterly cycle ending in December? (exact match)</h4>
          <span class="type">Type: Short Text</span>
        </header>
        <div class="body">
          <p>Hyphen optional.</p>
          <input type="text" inputmode="text" autocomplete="off" name="Q17" aria-label="Q17 input" placeholder="e.g. Q-DEC">
          <div class="explain" id="exp-Q17"><strong>Explanation:</strong> Q-DEC = 3/6/9/12 month quarter boundaries.</div>
        </div>
      </article>

      <!-- Q18 (Short Text: regex) -->
      <article class="q card" data-id="Q18" data-type="text" data-eval="regex" data-answer="easy.*cash|readily.*cash|convert.*cash|quick.*cash">
        <header>
          <h4>Q18: One-line definition of ‚ÄúLiquidity‚Äù.</h4>
          <span class="type">Type: Short Text</span>
        </header>
        <div class="body">
          <p>English OK (e.g. "Ease of converting to cash quickly").</p>
          <input type="text" inputmode="text" autocomplete="off" name="Q18" aria-label="Q18 input" placeholder="Type here">
          <div class="explain" id="exp-Q18"><strong>Explanation:</strong> Liquidity = ease / speed of cash conversion.</div>
        </div>
      </article>
    </section>

      <div class="card panel" id="bottom-actions">
        <div class="row" style="justify-content:flex-end">
          <button class="btn success" id="bottomShowAnswers" data-results-target="results-bottom">Show Answers & Score</button>
        </div>
        <div class="results card" id="results-bottom" aria-live="polite" style="display:none"></div>
      </div>

    <footer class="muted" style="margin-top:24px">
      <p>This page is a <em>LEARNING FIRST</em> drill to raise <strong id="footer-skill">ECB/BIS Finance Terms</strong> to ‚Äú<em id="footer-goal">Explain key terms in your own words</em>‚Äù level. Depth of understanding over raw score.</p>
      <p style="margin:.4rem 0 0"><span id="footer-brand"></span> <span id="copyright"></span></p>
    </footer>
  </div>

  <script>
    (function(){
      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
        const THEME_KEY='quizTheme';
        const prefersDark=window.matchMedia('(prefers-color-scheme: dark)');
        const locale=(document.documentElement.lang||'').toLowerCase();
        const DETAIL_TEXT=locale.startsWith('ja')?
          {
            detailHeading:'Ë©≥Á¥∞„É™„Çπ„Éà',
            detailDescription:'ÂêÑË®≠Âïè„ÅÆÂõûÁ≠î„ÉªÊ≠£Ëß£„Éª„Çπ„Ç≥„Ç¢„ÉªËß£Ë™¨„Çí„Åæ„Å®„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            columns:{question:'Ë®≠Âïè',response:'ÂõûÁ≠î',correct:'Ê≠£Ëß£',score:'„Çπ„Ç≥„Ç¢',explanation:'Ëß£Ë™¨'},
            status:{correct:'Ê≠£Ëß£',incorrect:'‰∏çÊ≠£Ëß£',unanswered:'Êú™ÂõûÁ≠î'},
            noAnswer:'Êú™ÂõûÁ≠î',
            notAvailable:'N/A',
            none:'„Å™„Åó'
          }:
          {
            detailHeading:'Detailed Breakdown',
            detailDescription:'Responses, correct answers, scores, and explanations for each question.',
            columns:{question:'Question',response:'Response',correct:'Correct Answer',score:'Score',explanation:'Explanation'},
            status:{correct:'Correct',incorrect:'Incorrect',unanswered:'Unanswered'},
            noAnswer:'Not answered',
            notAvailable:'N/A',
            none:'None'
          };
        // Per-choice explanations (EN)
        const CHOICE_EXPLANATIONS = {
          Q01: { a:'Flow: new transactions in the period, not a stock.', b:'Correct. Amount remaining outstanding at a point in time (stock).', c:'Policy rate target; unrelated to Outstanding.' },
          Q04: { a:'Correct. Central bank for the euro area (policy rates, liquidity).', b:'Audits are not the ECB‚Äôs core mandate.', c:'Fiscal deficits are managed by governments/ministries, not the ECB.' },
          Q05: { a:'Not a spread index.', b:'Sounds like a stability indicator, but not BSI.', c:'Correct. Banking Statistics (balance sheet items, stocks).' },
          Q06: { a:'Securities/derivatives are excluded.', b:'Correct. Cash and highly liquid deposits.', c:'Loans are not ‚Äúcurrency and deposits‚Äù.' },
          Q07: { a:'Correct. Manufacturing firms are NFCs (non‚Äëfinancial).', b:'Investment funds belong to OFIs (financial).', c:'Correct. Service sector firms are NFCs.', d:'Pension funds are ICPF (insurance/pension).' },
          Q08: { a:'Not a fiscal deficit aggregate.', b:'Not bank CET1 capital.', c:'Correct. Broad money including cash, deposits and near‚Äëmoney.' },
          Q09: { a:'Correct. Proxy for liquidity provision/monetary base scale.', b:'Unrelated to listed firms‚Äô profitability.', c:'Unrelated to household saving rate.' },
          Q10: { a:'Not only new lending this month.', b:'Correct. Lending amounts outstanding and not yet repaid.', c:'Not limited to defaults.' },
          Q11: { a:'Not volatility.', b:'Not GDP growth.', c:'Correct. Return/yield from a bond etc.' },
          Q12: { a:'Not policy rate minus gov bond yield.', b:'Correct. Corporate bond yield minus same‚Äëtenor gov bond yield.', c:'Not deposit minus loan rate (that‚Äôs bank margin/NIM).' },
          Q13: { a:'Correct. Bank lending/deposit rate statistics.', b:'Turnover is a stock market metric.', c:'Not a house price index.' },
          Q14: { a:'Correct. Loan stocks represent market depth.', b:'Spreads alone do not capture depth.', c:'Correct. Bond outstanding indicates size/depth.', d:'A single firm‚Äôs market cap is not representative.' },
          Q15: { a:'Not typically used this way for real estate.', b:'Correct. Stock market turnover ratio.', c:'Not a labour market indicator.' },
          Q16: { a:'Correct. Deposit Facility Rate is a key ECB rate.', b:'FFR is a US rate, not ECB.', c:'Correct. MRO is a key ECB rate.', d:'Govt bond yield is market‚Äëdetermined, not a policy rate.' }
        };

        // Rich notes (background + big picture)
        const DETAIL_NOTES = {
          Q01: '<div class="muted"><p><strong>Context:</strong> Outstanding = stock at a point in time; distinct from flow (new transactions).</p><ul><li>Accounting analogy: stock (balance sheet) vs flow (income/cash flow).</li><li>Dataset: ECB BSI "Outstanding amounts".</li><li>Practice: Large new lending and repayments can offset each other; flow ‚â† change in stock.</li></ul></div>',
          Q04: '<div class="muted"><p><strong>Context:</strong> ECB targets price stability via policy rates (MRO/DFR) and operations.</p><ul><li>DFR sets a floor; MRO is the main operation.</li><li>Fiscal deficits are government responsibility, not ECB.</li></ul></div>',
          Q05: '<div class="muted"><p><strong>Context:</strong> BSI = banking balance-sheet statistics. Primarily stocks by sector/instrument.</p><ul><li>Loans, deposits, security holdings.</li><li>Used to read credit conditions vs policy rates.</li></ul></div>',
          Q06: '<div class="muted"><p><strong>Context:</strong> Currency & deposits are the most liquid assets; core of broad money.</p></div>',
          Q07: '<div class="muted"><p><strong>Context:</strong> Sector classification basics. NFC = non‚Äëfinancial corporates; funds/pensions are financial sector.</p></div>',
          Q08: '<div class="muted"><p><strong>Context:</strong> M3 = broad money. A gauge of monetary thickness/credit environment.</p></div>',
          Q09: '<div class="muted"><p><strong>Context:</strong> Eurosystem total assets proxy liquidity provision scale; expanded during QE.</p></div>',
          Q10: '<div class="muted"><p><strong>Context:</strong> Loans outstanding = amounts not yet repaid. Changes reflect new lending minus repayments and revaluations.</p></div>',
          Q11: '<div class="muted"><p><strong>Context:</strong> Yield = expected return rate; shaped by rate expectations, inflation, and credit.</p></div>',
          Q12:'<div class="muted"><p><strong>Context:</strong> Credit spread is a thermometer of credit risk/conditions.</p><ul><li>Widening = tightening/uncertainty.</li><li>Narrowing = risk-on/easier conditions.</li></ul></div>',
          Q13:'<div class="muted"><p><strong>Context:</strong> MIR covers bank lending/deposit rates for households/firms.</p></div>',
          Q14:'<div class="muted"><p><strong>Context:</strong> Depth ‚âà size; measured naturally by stocks. Spreads alone do not capture depth.</p></div>',
          Q15:'<div class="muted"><p><strong>Context:</strong> Turnover ratio measures trading activity in equity markets.</p></div>',
          Q16:'<div class="muted"><p><strong>Context:</strong> Key ECB policy rates include MRO/DFR. FFR is US; gov bond yield is market‚Äëdetermined.</p></div>',
          Q17:'<div class="muted"><p><strong>Note:</strong> Q‚ÄëDEC denotes quarters ending in Dec (3/6/9/12 months).</p></div>',
          Q18:'<div class="muted"><p><strong>Context:</strong> Liquidity = ease/speed of converting to cash with small price impact.</p></div>'
        };

        function updateThemeToggle(mode){
          const btn=$('#themeToggle');
          if(!btn) return;
          const isLight=mode==='light';
          const next=isLight?'dark':'light';
          btn.dataset.next=next;
          btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
          btn.setAttribute('aria-label', next==='dark' ? 'Switch to dark mode' : 'Switch to light mode');
          const icon = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
          const label = next==='dark' ? 'Dark Mode' : 'Light Mode';
          btn.innerHTML = '<span class="theme-icon" aria-hidden="true">'+icon+'</span><span class="theme-label">'+label+'</span>';
        }

        function setTheme(mode, persist=true){
          const normalized = mode==='light' ? 'light' : 'dark';
          document.body.setAttribute('data-theme', normalized);
          if(persist){ try{ localStorage.setItem(THEME_KEY, normalized); }catch(e){} }
          updateThemeToggle(normalized);
        }

        function applyInitialTheme(){
          let stored=null;
          try{ stored = localStorage.getItem(THEME_KEY); }catch(e){ stored=null; }
          const initial = stored || (prefersDark.matches ? 'dark' : 'light');
          setTheme(initial,false);
        }

        function toggleTheme(){
          const current=document.body.getAttribute('data-theme')==='light'?'light':'dark';
          const next=current==='light'?'dark':'light';
          setTheme(next,true);
        }

        function toggleChipSelection(q, chip){
          if(!chip) return;
          if(q._selectedChip === chip){
            chip.classList.remove('selected');
            q._selectedChip = null;
            return;
          }
          if(q._selectedChip){ q._selectedChip.classList.remove('selected'); }
          q._selectedChip = chip;
          chip.classList.add('selected');
        }

        function clearChipSelection(q){
          if(q._selectedChip){
            q._selectedChip.classList.remove('selected');
            q._selectedChip = null;
          }
        }

        function moveChipToBucket(q, chip, bucket){
          if(!chip || !bucket) return;
          bucket.appendChild(chip);
          clearChipSelection(q);
          evaluateQuestion(q);
          if($('#learningMode').checked){ showExplain(q,true); }
          updateLiveScore();
        }

      function updateModeBadge(){
        const on = $('#learningMode').checked;
        const mb = $('#mode-badge');
        if(!mb) return;
        mb.textContent = on ? 'Learning Mode' : 'Test Mode';
        mb.setAttribute('aria-pressed', on ? 'true' : 'false');
        mb.setAttribute('title', on ? 'Click to switch to Test mode' : 'Click to switch to Learning mode');
      }
      function showExplain(q, show=true){
        const exp = q.querySelector('.explain');
        if(!exp) return;
        exp.classList.toggle('show', !!show);
        if(show && !exp.dataset.choicesInjected){
          const qid=q.dataset.id; const map=CHOICE_EXPLANATIONS[qid];
          if(map){
            const gold=(q.dataset.answer||'').split(',').map(s=>s.trim());
            const box=document.createElement('div'); box.className='muted'; box.style.marginTop='8px';
            let html='<div style="font-weight:600;margin:4px 0 6px">Choice explanations</div><ul style="margin:0 0 0 1.1rem;line-height:1.5">';
            ['a','b','c','d','e'].forEach(k=>{ if(map[k]){ const mark=gold.includes(k)?'‚úÖ':'‚úñ'; html+='<li>'+mark+' '+k.toUpperCase()+'. '+map[k]+'</li>'; }});
            html+='</ul>'; box.innerHTML=html; exp.appendChild(box);
          }
          exp.dataset.choicesInjected='1';
        }
        if(show && !exp.dataset.richInjected){
          const id=q.dataset.id;
          const svgQ1=()=>'<svg width="100%" height="70" viewBox="0 0 320 70" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Stock vs Flow"><defs><linearGradient id="ge1" x1="0" x2="1"><stop offset="0" stop-color="rgba(78,161,255,0.3)"/><stop offset="1" stop-color="rgba(155,227,127,0.25)"/></linearGradient></defs><rect x="8" y="14" width="136" height="36" rx="8" fill="url(#ge1)" stroke="rgba(78,161,255,0.6)"/><text x="76" y="36" text-anchor="middle" fill="currentColor" font-size="12">Stock</text><path d="M176 32 h70" stroke="rgba(78,161,255,0.8)" stroke-width="3"/><polygon points="246,32 236,27 236,37" fill="rgba(78,161,255,0.8)"/><text x="206" y="24" fill="currentColor" font-size="12">Flow</text></svg>';
          const svgQ10=()=>'<svg width="100%" height="80" viewBox="0 0 360 80" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Credit spread"><line x1="40" y1="52" x2="320" y2="52" stroke="rgba(120,160,200,0.5)"/><polyline points="40,50 100,46 160,44 220,45 280,43 320,42" stroke="rgba(90,200,140,0.9)" fill="none" stroke-width="2"/><polyline points="40,36 100,32 160,28 220,30 280,28 320,27" stroke="rgba(80,140,255,0.95)" fill="none" stroke-width="2"/><path d="M160 44 v-12" stroke="rgba(255,255,255,0.7)" stroke-width="2"/><text x="170" y="38" fill="currentColor" font-size="12">spread</text><text x="8" y="30" fill="currentColor" font-size="12">Corp</text><text x="8" y="48" fill="currentColor" font-size="12">Gov</text></svg>';
          let fig=''; if(id==='Q1') fig=svgQ1(); if(id==='Q10') fig=svgQ10();
          if(fig){ const w=document.createElement('div'); w.className='muted'; w.style.marginTop='8px'; w.innerHTML=fig; exp.appendChild(w);} exp.dataset.richInjected='1';
        }
        // Detailed notes once
        if(show && !exp.dataset.notesInjected){
          const id=q.dataset.id; const html=DETAIL_NOTES[id];
          if(html){ const w=document.createElement('div'); w.innerHTML=html; exp.appendChild(w); }
          exp.dataset.notesInjected='1';
        }
        const btn = q.querySelector('.answer-btn');
        if(btn){
          btn.textContent = exp.classList.contains('show') ? 'Hide explanation' : 'Show answer';
        }
      }
      function evaluateQuestion(q){
        const id = q.dataset.id;
        const type = q.dataset.type;
        const ans = (q.dataset.answer||'').trim();
        let ok=null,user=null;
        if(type==='mc'){
          const picked = q.querySelector('input[type=radio]:checked');
          if(!picked){ok=null;} else {user=picked.value; ok = (user===ans); markChoices(q,[user], ans.split(','));}
        } else if(type==='ms'){
          const picked = q.querySelectorAll('input[type=checkbox]:checked');
          user = Array.from(picked).map(i=>i.value).sort();
          const gold = ans.split(',').map(s=>s.trim()).sort();
          ok = JSON.stringify(user)===JSON.stringify(gold);
          markChoices(q,user,gold);
        } else if(type==='classify'){
          const parse = s=>Object.fromEntries(s.split(';').map(p=>{const [g,l]=p.split(':'); return [g.trim(), (l?l.split(',').map(x=>x.trim()).filter(Boolean):[])];}));
          const goldMap=parse(ans); const groups=Object.keys(goldMap);
          const userMap={}; groups.forEach(g=>{const box=q.querySelector('.bucket[data-group="'+g+'"]'); const vals=Array.from(box?.querySelectorAll('.chip')||[]).map(c=>c.dataset.value).filter(Boolean).sort(); userMap[g]=vals;});
          const eq=(a,b)=>JSON.stringify((a||[]).slice().sort())===JSON.stringify((b||[]).slice().sort());
          ok=groups.every(g=>eq(userMap[g],goldMap[g]));
          user=groups.map(g=>g+':'+(userMap[g]||[]).join(',')).join(' | ');
        } else if(type==='segment'){
          const picked = q.dataset.segmentSelected || '';
          user = picked; ok = picked ? (picked===ans) : null;
        } else if(type==='text'){
          const input = q.querySelector('input[type=text]');
          user=(input?.value||'').trim();
          const mode=(q.dataset.eval||'exact').toLowerCase();
          if(mode==='regex'){try{const re=new RegExp(ans,'i'); ok = re.test(user);}catch(e){ok=false;}} else {ok=(user===ans);} }
        return {id,ok,user,type};
      }
      function markChoices(q, userValues, goldValues){
        q.querySelectorAll('.choice').forEach(lbl=>{
          lbl.classList.remove('correct','wrong');
          const v = lbl.querySelector('input')?.value;
          if(!v) return;
          if(userValues?.includes(v)){
            lbl.classList.add(goldValues.includes(v)?'correct':'wrong');
          }
        });
      }
      function resolveResultsBox(targetId){
        if(targetId){
          const el=document.getElementById(targetId);
          if(el) return el;
        }
        return document.getElementById('results-panel-top') || $('#results') || document.querySelector('.results');
      }
      function renderResults(targetId){
        const rows=[];
        $$('#questions .q').forEach(q=>{
          const r=evaluateQuestion(q);
          const state=r.ok===null?'Unanswered':(r.ok?'Correct':'Wrong');
          const expEl=q.querySelector('.explain');
          const expHtml=expEl?expEl.innerHTML.trim():'';
          rows.push('<tr><td>'+r.id+'</td><td>'+r.type+'</td><td>'+escapeHtml(stringifyAnswerValue(r.user))+'</td><td>'+state+'</td><td>'+(expHtml||'')+'</td></tr>');
        });
        const html = '<h4 style="margin:0 0 8px">Results (learning view)</h4><table aria-label="results"><thead><tr><th>Q ID</th><th>Type</th><th>Answer</th><th>Result</th><th>Explanation</th></tr></thead><tbody>'+rows.join('')+'</tbody></table>';
        const box=resolveResultsBox(targetId);
        if(!box) return;
        box.innerHTML=html;
        box.style.display='block';
      }
      function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

      function ensureBottomDetailBox(){
        let box=document.getElementById('results-bottom-detail');
        if(box) return box;
        box=document.createElement('div');
        box.className='results card results-detail';
        box.id='results-bottom-detail';
        box.style.display='none';
        box.style.marginTop='12px';
        const anchor=document.getElementById('results-bottom');
        if(anchor && anchor.parentNode){
          anchor.parentNode.insertBefore(box, anchor.nextSibling);
        } else {
          const panel=document.getElementById('bottom-actions');
          if(panel){ panel.appendChild(box); }
          else { document.body.appendChild(box); }
        }
        return box;
      }
      function describeChoiceLabel(q,value){
        if(!value) return '';
        const input=Array.from(q.querySelectorAll('.choice input')).find(el=>el.value===value);
        if(!input) return value;
        const choice=input.closest('.choice');
        return choice ? choice.textContent.trim() : value;
      }
      function describeChoiceList(q,values){
        if(!values) return '';
        const arr=Array.isArray(values)?values:[values];
        return arr.map(v=>describeChoiceLabel(q,v)).filter(Boolean).join(', ');
      }
      function describeSegmentLabel(q,value){
        if(!value) return '';
        const btn=q.querySelector('.segment[data-idx="'+value+'"]');
        return btn ? btn.textContent.trim() : value;
      }
      function describeChipLabel(q,value){
        const chip=Array.from(q.querySelectorAll('.chip')).find(el=>el.dataset.value===value);
        return chip ? chip.textContent.trim() : value;
      }
      function getBucketLabel(q,group){
        const bucket=q.querySelector('.bucket[data-group="'+group+'"]');
        return bucket?.querySelector('h5')?.textContent.trim() || group;
      }
      function describeClassifyMappingText(q,mapping){
        if(!mapping) return '';
        const parts=mapping.split(';').map(p=>p.trim()).filter(Boolean);
        if(!parts.length) return '';
        return parts.map(part=>{
          const [groupRaw,valuesRaw='']=part.split(':');
          const group=groupRaw?.trim()||'';
          const label=getBucketLabel(q,group) || group;
          const values=valuesRaw.split(',').map(v=>v.trim()).filter(Boolean);
          const names=values.map(val=>describeChipLabel(q,val));
          return label+': '+(names.length?names.join(', '):DETAIL_TEXT.none);
        }).join(' / ');
      }
      function describeClassifyUserSelection(q){
        const buckets=Array.from(q.querySelectorAll('.bucket[data-group]')).filter(b=>b.dataset.group!=='pool');
        if(!buckets.length) return '';
        return buckets.map(bucket=>{
          const label=bucket.querySelector('h5')?.textContent.trim() || bucket.dataset.group || '';
          const chips=Array.from(bucket.querySelectorAll('.chip')).map(ch=>ch.textContent.trim()).filter(Boolean);
          return label+': '+(chips.length?chips.join(', '):DETAIL_TEXT.none);
        }).join(' / ');
      }
      function formatUserAnswerDisplay(q,evaluation){
        const type=q.dataset.type;
        if(type==='mc'){
          return evaluation.user ? describeChoiceLabel(q,evaluation.user) : '';
        }
        if(type==='ms'){
          const vals=Array.isArray(evaluation.user)?evaluation.user:[];
          if(!vals.length) return '';
          return describeChoiceList(q,vals);
        }
        if(type==='text'){
          return evaluation.user || '';
        }
        if(type==='classify'){
          return describeClassifyUserSelection(q);
        }
        if(type==='segment'){
          return evaluation.user ? describeSegmentLabel(q,evaluation.user) : '';
        }
        return Array.isArray(evaluation.user)?evaluation.user.join(', '):(evaluation.user||'');
      }
      function formatCorrectAnswerDisplay(q){
        const type=q.dataset.type;
        const ans=(q.dataset.answer||'').trim();
        if(!ans) return '';
        if(type==='mc') return describeChoiceLabel(q,ans);
        if(type==='ms'){
          const vals=ans.split(',').map(s=>s.trim()).filter(Boolean);
          return describeChoiceList(q,vals);
        }
        if(type==='text'){
          const mode=(q.dataset.eval||'exact').toLowerCase();
          return mode==='regex' ? 'Regex: '+ans : ans;
        }
        if(type==='segment') return describeSegmentLabel(q,ans);
        if(type==='classify') return describeClassifyMappingText(q,ans);
        return ans;
      }
      function buildQuestionDetail(q,evaluation){
        return {
          id:evaluation.id,
          title:q.querySelector('h4')?.textContent.trim() || evaluation.id,
          userDisplay:formatUserAnswerDisplay(q,evaluation),
          correctDisplay:formatCorrectAnswerDisplay(q),
          explanationHTML:q.querySelector('.explain')?.innerHTML.trim() || '',
          ok:evaluation.ok
        };
      }
      function scoreLabel(ok){
        if(ok===true) return DETAIL_TEXT.status.correct;
        if(ok===false) return DETAIL_TEXT.status.incorrect;
        return DETAIL_TEXT.status.unanswered;
      }
      function stringifyAnswerValue(value){
        if(Array.isArray(value)) return value.join(', ');
        if(value===undefined || value===null) return '';
        return value.toString ? value.toString() : String(value);
      }
      function renderBottomDetail(details){
        if(!details || !details.length) return;
        const box=ensureBottomDetailBox();
        if(!box) return;
        const rows=details.map(item=>
          '<tr>'+
            '<td><div><strong>'+escapeHtml(item.id)+'</strong></div><div>'+escapeHtml(item.title)+'</div></td>'+
            '<td>'+escapeHtml(item.userDisplay || DETAIL_TEXT.noAnswer)+'</td>'+
            '<td>'+escapeHtml(item.correctDisplay || DETAIL_TEXT.notAvailable)+'</td>'+
            '<td>'+escapeHtml(scoreLabel(item.ok))+'</td>'+
            '<td>'+(item.explanationHTML || '')+'</td>'+
          '</tr>'
        ).join('');
        box.innerHTML=
          '<h4 style="margin:0 0 8px">'+DETAIL_TEXT.detailHeading+'</h4>'+
          '<div class="table-wrapper">'+
            '<table><thead><tr>'+
              '<th>'+DETAIL_TEXT.columns.question+'</th>'+
              '<th>'+DETAIL_TEXT.columns.response+'</th>'+
              '<th>'+DETAIL_TEXT.columns.correct+'</th>'+
              '<th>'+DETAIL_TEXT.columns.score+'</th>'+
              '<th>'+DETAIL_TEXT.columns.explanation+'</th>'+
            '</tr></thead><tbody>'+rows+'</tbody></table>'+
          '</div>';
        box.style.display='block';
      }

      // Apply brand into header/footer
      (function applyBrand(){
        const S = window.DRILL_SETTINGS || {};
        const bName = S.BRAND_NAME || 'ToppyMicroServices';
        const bLogo = S.BRAND_LOGO || 'og-brand-clean.min.png';
        const bUrl  = S.BRAND_URL  || '/';
        const nameEl = $('#brand-name');
        if(nameEl) nameEl.textContent = bName;
        const l = $('#brand-link');
        if(l) l.setAttribute('href', bUrl);
        const img = $('#brand-logo');
        if(img && bLogo){ img.src = bLogo; img.alt = bName; img.style.display = 'inline-block'; }
        const fb = $('#footer-brand');
        if(fb){ fb.innerHTML = '<strong>'+bName+'</strong>' + (bUrl && bUrl!=='#' ? ' ‚Äì <a href="'+bUrl+'">'+bUrl+'</a>' : ''); }
        const year = new Date().getFullYear();
        const cEl = $('#copyright');
        if(cEl) cEl.textContent = '¬© '+year+' '+bName+'. All rights reserved.';
      })();

      // Handlers
        const themeBtn = $('#themeToggle');
        if(themeBtn){ themeBtn.addEventListener('click',()=>{toggleTheme(); updateLiveScore();}); }
        const lmEl = $('#learningMode');
        if(lmEl){ lmEl.addEventListener('change',()=>{updateModeBadge(); if(!$('#learningMode').checked){$$('.explain').forEach(e=>e.classList.remove('show'));} updateLiveScore();}); }
  // Header mode badge toggles the mode as well
  (function(){
    const mb = $('#mode-badge');
    if(!mb) return;
    const toggleMode = ()=>{ const lm=$('#learningMode'); lm.checked=!lm.checked; lm.dispatchEvent(new Event('change')); };
    mb.addEventListener('click', toggleMode);
    mb.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleMode(); }});
  })();
      const showAllBtn = $('#showAll');
      if(showAllBtn){ showAllBtn.addEventListener('click',()=>{$$('.explain').forEach(e=>e.classList.add('show')); updateLiveScore();}); }
      const hideAllBtn = $('#hideAll');
      if(hideAllBtn){ hideAllBtn.addEventListener('click',()=>{$$('.explain').forEach(e=>e.classList.remove('show')); updateLiveScore();}); }
      const regenBtn = $('#regen');
      if(regenBtn){
        regenBtn.addEventListener('click',()=>renderResults(regenBtn.dataset.resultsTarget));
      }
      const showScoreBtn = $('#showAnswersScore');
      if(showScoreBtn){
        showScoreBtn.addEventListener('click',()=>showAnswersAndScore(showScoreBtn.dataset.resultsTarget));
      }
      const bottomBtn = $('#bottomShowAnswers');
      if(bottomBtn){
        bottomBtn.addEventListener('click',()=>{
          showAnswersAndScore(bottomBtn.dataset.resultsTarget);
          const dd=document.querySelector('details.cheatsheet');
          if(dd){ dd.open=true; }
        });
      }
      $$('#questions .q').forEach(q=>{
        const type=q.dataset.type;
        if(type==='mc'){q.querySelectorAll('input[type=radio]').forEach(r=>r.addEventListener('change',()=>{evaluateQuestion(q); if($('#learningMode').checked){showExplain(q,true);}}));}
        else if(type==='ms'){q.querySelectorAll('input[type=checkbox]').forEach(r=>r.addEventListener('change',()=>{evaluateQuestion(q); if($('#learningMode').checked){showExplain(q,true);}}));}
        else if(type==='text'){const t=q.querySelector('input[type=text]'); t?.addEventListener('input',()=>{evaluateQuestion(q); if($('#learningMode').checked && t.value.trim().length){showExplain(q,true);}});} 
        else if(type==='classify'){
          const chips=q.querySelectorAll('.chip');
          chips.forEach(ch=>{
            ch.setAttribute('tabindex','0');
            ch.addEventListener('dragstart',e=>{
              e.dataTransfer.setData('text/plain', ch.dataset.value||'');
              q._dragEl = ch;
              clearChipSelection(q);
            });
            ch.addEventListener('dragend',()=>{ q._dragEl = null; });
            ch.addEventListener('click',()=>toggleChipSelection(q,ch));
            ch.addEventListener('keydown',e=>{
              if(e.key===' '||e.key==='Enter'){
                e.preventDefault();
                toggleChipSelection(q,ch);
              }
            });
          });
          q.querySelectorAll('.bucket').forEach(b=>{
            b.addEventListener('dragover',e=>{e.preventDefault(); b.classList.add('hover');});
            b.addEventListener('dragleave',()=>b.classList.remove('hover'));
            b.addEventListener('drop',e=>{
              e.preventDefault();
              b.classList.remove('hover');
              if(q._dragEl){
                moveChipToBucket(q,q._dragEl,b);
                q._dragEl = null;
              }
            });
            b.addEventListener('click',()=>{
              if(q._selectedChip){
                moveChipToBucket(q,q._selectedChip,b);
              }
            });
          });
        } else if(type==='segment'){
          q.querySelectorAll('.segment').forEach(btn=>{
            btn.addEventListener('click',()=>{ q.querySelectorAll('.segment').forEach(x=>x.classList.remove('selected')); btn.classList.add('selected'); q.dataset.segmentSelected = btn.dataset.idx; evaluateQuestion(q); if($('#learningMode').checked){showExplain(q,true);} updateLiveScore(); });
          });
          const cv=$('#miniChart'); if(cv && cv.getContext){ const ctx=cv.getContext('2d'); const W=cv.width,H=cv.height; ctx.clearRect(0,0,W,H); const m=24; const h=H-2*m,w=W-2*m; const xi=i=>m+(i/8)*w; const yi=v=>m+(1-v)*h; const rate=[0.2,0.22,0.25,0.28,0.35,0.5,0.55,0.52,0.48]; const loan=[0.55,0.56,0.58,0.57,0.53,0.48,0.44,0.43,0.45]; ctx.strokeStyle='rgba(80,140,255,0.9)'; ctx.lineWidth=2; ctx.beginPath(); rate.forEach((v,i)=>{const px=xi(i),py=yi(v); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);}); ctx.stroke(); ctx.strokeStyle='rgba(100,220,150,0.9)'; ctx.beginPath(); loan.forEach((v,i)=>{const px=xi(i),py=yi(v); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);}); ctx.stroke(); }
        }
      });

      function computeLiveScore(){
        const qs = $$('#questions .q'); let total=0,answered=0,correct=0;
        const arrEq=(a,b)=>JSON.stringify((a||[]).slice().sort())===JSON.stringify((b||[]).slice().sort());
        qs.forEach(q=>{
          total++;
          const type=q.dataset.type; const ans=(q.dataset.answer||'').trim(); let ok=null;
          if(type==='mc'){ const p=q.querySelector('input[type=radio]:checked')?.value; if(p){answered++; ok=(p===ans);} }
          else if(type==='ms'){ const picked=Array.from(q.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value); if(picked.length){answered++; ok=arrEq(picked, ans.split(',').map(s=>s.trim()));} }
          else if(type==='text'){ const v=q.querySelector('input[type=text]')?.value.trim(); if(v){answered++; const mode=(q.dataset.eval||'exact').toLowerCase(); ok = (mode==='regex') ? (()=>{try{return new RegExp(ans,'i').test(v);}catch(e){return false;}})() : (v===ans); } }
          else if(type==='classify'){ const parse=s=>Object.fromEntries(s.split(';').map(p=>{const [g,l]=p.split(':'); return [g.trim(), (l?l.split(',').map(x=>x.trim()).filter(Boolean):[])];})); const gold=parse(ans); const groups=Object.keys(gold); let any=false; const eq=(a,b)=>JSON.stringify((a||[]).slice().sort())===JSON.stringify((b||[]).slice().sort()); const all=groups.every(g=>{ const vals=Array.from(q.querySelector('.bucket[data-group="'+g+'"]')?.querySelectorAll('.chip')||[]).map(c=>c.dataset.value); if(vals.length) any=true; return eq(vals,gold[g]);}); if(any){answered++; ok=all;} }
          else if(type==='segment'){ const p=q.dataset.segmentSelected; if(p){answered++; ok=(p===ans);} }
          if(ok===true) correct++;
        });
        return {total,answered,correct};
      }
      function updateLiveScore(){ const s=computeLiveScore(); const el=$('#score-badge'); if(el){ el.textContent = s.correct+' / '+s.total; el.title = 'Answered '+s.answered+' / '+s.total; } }

      function injectAnswerButtons(){
        $$('#questions .q').forEach(q=>{
          if(q.querySelector('.answer-btn')) return;
          let footer=q.querySelector('footer');
          if(!footer){footer=document.createElement('footer');footer.className='row';q.appendChild(footer);}
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='answer-btn';
          btn.textContent='Show answer';
          btn.addEventListener('click',()=>{
            const exp=q.querySelector('.explain');
            if(!exp) return;
            const willShow=!exp.classList.contains('show');
            showExplain(q,willShow);
            if(willShow){exp.scrollIntoView({behavior:'smooth',block:'nearest'});}
          });
          footer.appendChild(btn);
        });
      }

      function isAnswered(q){
        const t=q.dataset.type;
        if(t==='mc') return !!q.querySelector('input[type=radio]:checked');
        if(t==='ms') return q.querySelectorAll('input[type=checkbox]:checked').length>0;
        if(t==='text'){
          const v=q.querySelector('input[type=text]')?.value.trim();
          return !!v;
        }
        if(t==='classify'){
          const stock=q.querySelector('.bucket[data-group="stock"]');
          const flow=q.querySelector('.bucket[data-group="flow"]');
          const hasStock=stock && stock.querySelectorAll('.chip').length>0;
          const hasFlow=flow && flow.querySelectorAll('.chip').length>0;
          return hasStock || hasFlow;
        }
        if(t==='segment'){
          return !!q.dataset.segmentSelected;
        }
        return false;
      }
      function showAnswersAndScore(targetId){
        let total=0, correct=0, answered=0;
        const rows=[];
        const questionDetails=[];
        $$('#questions .q').forEach(q=>{
          total++;
          const r=evaluateQuestion(q);
          if(isAnswered(q)) answered++;
          if(r.ok===true) correct++;
          const gold=(q.dataset.answer||'').split(',').map(s=>s.trim());
          if(q.dataset.type==='mc' || q.dataset.type==='ms'){
            q.querySelectorAll('.choice').forEach(lbl=>{
              const v=lbl.querySelector('input')?.value; if(!v) return;
              if(gold.includes(v)) lbl.classList.add('correct');
            });
          } else if(q.dataset.type==='text'){
            const exp=q.querySelector('.explain');
            if(exp && !exp.dataset.hinted){
              const hint=document.createElement('div'); hint.className='muted';
              hint.innerHTML='<strong>Answer hint:</strong> regex: <code>'+escapeHtml(q.dataset.answer||'')+'</code>';
              exp.appendChild(hint); exp.dataset.hinted='1';
            }
          }
          showExplain(q,true);
          const qTitle=q.querySelector('h4')?.textContent.trim() || q.dataset.id;
          const expHtml=q.querySelector('.explain')?.innerHTML.trim() || '';
          const status=r.ok===true ? 'Correct' : r.ok===false ? 'Wrong' : 'Unanswered';
          const correctDisplay=formatCorrectAnswerDisplay(q,r) || '';
          rows.push('<tr>'+
            '<td><div><strong>'+r.id+'</strong></div><div>'+escapeHtml(qTitle)+'</div></td>'+
            '<td>'+escapeHtml(stringifyAnswerValue(r.user))+'</td>'+ 
            '<td>'+escapeHtml(correctDisplay)+'</td>'+ 
            '<td>'+status+'</td>'+ 
            '<td>'+(expHtml||'')+'</td>'+ 
          '</tr>');
          questionDetails.push(buildQuestionDetail(q,r));
        });
        const box=resolveResultsBox(targetId);
        if(!box) return;
        const table='<div class="table-wrapper"><table><thead><tr><th>Question</th><th>Your Answer</th><th>Answer</th><th>Result</th><th>Explanation</th></tr></thead><tbody>'+rows.join('')+'</tbody></table></div>';
        box.innerHTML = '<h4 style="margin:0 0 8px">Score</h4>'+
          '<p>Correct: <strong>'+correct+'</strong> / '+total+' (answered: '+answered+')</p>'+table;
        box.style.display='block';
        return {total,correct,answered,questionDetails};
      }

      applyInitialTheme();
      prefersDark.addEventListener?.('change',event=>{
        let stored=null;
        try{ stored = localStorage.getItem(THEME_KEY); }catch(e){ stored=null; }
        if(stored) return;
        setTheme(event.matches?'dark':'light',false);
      });
      updateModeBadge();
      injectAnswerButtons();
      updateLiveScore();
    })();
  </script>
</body>
</html>
